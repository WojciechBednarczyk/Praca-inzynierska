\chapter{Testy}
Testy s¹ nieod³¹czn¹ czêœci¹ ka¿dej aplikacji. Przed jej wdro¿eniem lub dostarczeniem nowej funkcjonalnoœci nale¿y sprawdziæ czy zaimplementowana funkcjonalnoœæ dzia³a wed³ug specyfikacji. Ponadto nale¿y przetestowaæ przypadki krytyczne jak np.\ wysy³anie zapytania w momencie kiedy wymagane pole jest puste. Pozwala to wykryæ b³êdy jeszcze przed wdro¿eniem funkcjonalnoœci.

Istnieje wiele rodzajów testów. Niektóre z nich mo¿na przeprowadziæ automatycznie, a niektóre manualnie. W projektowanej aplikacji, aby sprawdziæ poprawnoœæ implementacji skupiono siê przede wszystkim na testach jednostkowych oraz testach integracyjnych.
 
\section{Testy jednostkowe}

Testy jednostkowe to testy które pozwalaj¹ sprawdziæ czy zaimplementowana logika biznesowa dzia³a tak jak powinna. Testowane s¹ g³ównie metody które s¹ sprawdzane czy po ich wywo³aniu daj¹ oczekiwany rezultat.

W projektowanej aplikacji do testów jednostkowych wykorzystano bibliotekê JUnit 5. Jest to obecnie najpopularniejsza biblioteka do testowania dla aplikacji pisanych w Javie. Œwiadczy o tym 1. miejsce w repozytorium Mavena pod wzglêdem u¿yæ. Testy JUnit oferuj¹ ³atwoœæ w pisaniu kodu testowego. S¹ one przeprowadzane automatycznie, a rezultat testu jest wyœwietlany natychmiastowo po jego przetworzeniu. Dobrym uzupe³nieniem biblioteki JUnit jest biblioteka AssertJ. Oferuje ona znacznie wiêcej asercji, dziêki czemu kod mo¿e byæ przetestowany jeszcze dok³adniej. Testy w projektowanej aplikacji zosta³y napisane w oparciu o konwencjê BDD. Polega ona m.in. nazwaniu metody testowej w taki sposób, aby sama nazwa oznacza³a co test ma sprawdzaæ oraz na podzieleniu kodu testowego na 3 sekcje: 
\begin{itemize}
\item Given - Sekcja w której tworzone s¹ za³o¿enia pocz¹tkowe. Przygotowywane s¹ dane które bêd¹ przekazywane do testowanych metod
\item When - Sekcja w której wykonuj¹ siê wszystkie metody s¹ testowane
\item Then - Sprawdzanie czy otrzymany rezultat zgodny z oczekiwanym rezultatem. Najczêœciej wykorzystuje siê do tego asercje
\end{itemize}

Na listingu ~\ref{lst:OpinionMapperTest} przedstawiono przyk³adowy test klasy OpinionMapper z wykorzystaniem wczeœniej wymienionych technik. Metody testowe powinny byæ oznaczone anotacjami \texttt{@Test}. W sekcji \emph{Given} zdefiniowano dane wejœciowe oraz oczekiwany rezultat. Nastêpnie w sekcji \emph{When} wywo³ano sprawdzan¹ metodê, a w sekcji \emph{Then} sprawdzono poprawonœæ dzia³ania metody poprzez asercje. Zweryfikowano czy rezultat nie jest pust¹ list¹, czy ma taki sam rozmiar jak oczekiwany rezultat, a tak¿e czy zawartoœæ otrzymanej listy jest zgodna z oczekiwan¹ wartoœci¹.

\begin{lstlisting}[language=Java,style=JavaStyle,caption=Kod Ÿród³owy klasy testowej \emph{OpinionMapperTest}, label=lst:OpinionMapperTest]
		@Test
    public void shoukdMapOpinionsToDto(){

        // Given
        OpinionMapper opinionMapper = new OpinionMapper();

        OpinionDto opinionDto1 = OpinionDto.builder()
                (...)
                .build();

        OpinionDto opinionDto2 = OpinionDto.builder()
                (...)
                .build();
								
        List<OpinionDto> expectedResult = List.of(opinionDto1,opinionDto2);

        Mentee mentee = new Mentee();
        PersonalTrainer personalTrainer = new PersonalTrainer();
        mentee.setId(1);
        personalTrainer.setId(2);
        Opinion opinion1 = new Opinion(1,"opinion 1",5,mentee,personalTrainer);
        Opinion opinion2 = new Opinion(2,"opinion 2",4,mentee,personalTrainer);
        List<Opinion> opinions = List.of(opinion1,opinion2);

        // When
        List<OpinionDto> result = opinionMapper.mapOpinionsToDto(opinions);

        // Then
        assertThat(result)
						.isNotEmpty()
						.hasSameSizeAs(expectedResult)
						.usingRecursiveComparison().isEqualTo(expectedResult);
    }
\end{lstlisting}

W niektórych przypadkach jednak te dwie biblioteki nie wystarcz¹. Zdarza siê, ¿e testowana jednostka jest zale¿na od innych jednostek, a test jednostkowy nie powinien wykraczaæ poza jej granice. W takiej sytuacji nale¿y skorzystaæ z tzw. mocków. Mock jest obiektem który ma imitowaæ rzeczywisty obiekt. Dziêki niemu nie ma koniecznoœci implementacji danego obiektu. Mock pozwala zdefiniowaæ jak obiekt ma siê zachowywaæ w okreœlonych przypadkach.

W Javie najpopularniejsz¹ bibliotek¹ wspieraj¹c¹ mocki jest Mockito. Ponadto, dobrze integruje siê wraz z JUnit 5 poprzez dodanie jednej zale¿noœci w pliku konfiguracyjnym. Na listingu ~\ref{lst:ExerciseServiceTest} przedstawiono dzia³anie tej biblioteki. Aby JUnit 5 oraz Mockito dzia³a³o razem poprawnie, nale¿y oznaczyæ klasê anotacj¹ \texttt{@ExtendWith(MockitoExtension.class)}. W klasie zadeklarowano dwa obiekty klas \texttt{ExerciseRepository} oraz \texttt{ExerciseMapper} które zosta³y oznaczone anotacjami \texttt{@Mock} dziêki czemu zosta³y utworzone mocki. Ponadto zadeklarowano obiekt klasy \texttt{ExerciseService} której metoda jest testowana w poni¿szym przyk³adzie. Poniewa¿ obiekt ten zawiera zale¿noœci do wczeœniej wspomnianych klas, oznaczony zosta³ anotacj¹ \texttt{@InjectMocks} przez co wczeœniej utworzone mocki zostan¹ automatycznie wstrzykniête do mocka serwisu. W samym teœcie, w sekcji \emph{Given} oprócz danych testowych oraz oczekiwanych rezultatów wykorzystano metodê \texttt{when} z biblioteki Mockito która pozwala zdefiniowaæ wyniki wywo³añ poszczególnych metod. Na koñcu testu za pomoc¹ metody \texttt{verify}, zweryfikowano czy dane metody rzeczywiœcie zosta³y wywo³ane. 

\begin{lstlisting}[language=Java,style=JavaStyle,caption=Kod Ÿród³owy klasy testowej \emph{ExerciseServiceTest}, label=lst:ExerciseServiceTest]
@ExtendWith(MockitoExtension.class)
public class ExerciseServiceTest {
    
    @InjectMocks
    private ExerciseService exerciseService;

    @Mock
    private ExerciseRepository exerciseRepository;

    @Mock
    private ExerciseMapper exerciseMapper;

    @Test
    public void shouldFindAllExerises(){
        // Given
        List<ExerciseDto> expectedResult = List.of(
                new ExerciseDto(1,"name 1","desc 1","url 1",4,"Chest"),
                new ExerciseDto(2,"name 2","desc 2","url 2",5,"Legs"));

        List<Exercise> queryResult = List.of(
                new Exercise(1,"name 1","desc 1","url 1",4,"Chest"),
                new Exercise(2,"name 2","desc 2","url 2",5,"Legs"));
        when(exerciseRepository.findAll()).thenReturn(queryResult);
        when(exerciseMapper.mapExercisesToDto(queryResult)).thenReturn(expectedResult);
        
        // When
        List<ExerciseDto> result = exerciseService.findAll();

        // Then
				verify(exerciseRepository).findAll();
        verify(exerciseMapper).mapExercisesToDto(queryResult);
        assertThat(result)
							.isNotEmpty();
							.hasSameSizeAs(expectedResult);
							.usingRecursiveComparison().isEqualTo(expectedResult);
    }
}

\end{lstlisting}

\section{Testy integracyjne}

Testy integracyjne s³u¿¹ do przetestowania interakcji pomiêdzy poszczególnymi komponentami systemu. W projektowanej aplikacji mo¿e to byæ po³¹czenie pomiêdzy frontendem, a backendem. Po ka¿dym zaimplementowaniu nowej funkcjonalnoœci po stronie backendu, testowano czy kontrolery zosta³y zaimplementowane w prawid³owy sposób. Sprawdzano czy odbieraj¹ odpowiednie ¿¹dania oraz zwracaj¹ odpowiednie wiadomoœci. Testy te by³y przeprowadzane rêcznie za pomoc¹ aplikacji Postman.

Postman jest darmow¹ aplikacj¹ s³u¿¹c¹ do testowania API. Jest narzêdziem chêtnie wybieranym przez programistów do przeprowadzania testów integracyjnych. Pozwala na wysy³anie ¿¹dañ na konkrenty adres URL z oczekiwaniem na odpowiedŸ która jest nastêpnie wyœwietlana. Ponadto do wysy³anych ¿¹dañ mo¿na w ³atwy sposób dodaæ parametry ¿¹dania, nag³ówki oraz cia³o ¿¹dania w wybranym formacie np. JSON.

Na rysunku ~\ref{fig:rejestracja-sukces} przedstawiono przyk³adowe wys³anie ¿¹dania dotycz¹cego rejestracji nowego u¿ytkownika. ¯¹danie wys³ano metod¹ \texttt{POST} ze wszystkimi potrzebnymi danymi w ciele ¿¹dania. W odpowiedzi otrzymano kod odpowiedzi oraz cia³o odpowiedzi. Kod odpowiedzi 200 oraz treœæ odpowiedzi potwierdzaj¹ poprawnoœæ zaimplementowanej funkcji.

\begin{figure}[htb]
  \centering
	\includegraphics[width=0.7\textwidth]{rys06/rejestracja-sukces}
	\caption{Wys³anie ¿¹dania rejestracji nowego u¿ytkownika z aplikacji Postman - sukces}
  \label{fig:rejestracja-sukces}
\end{figure}

Na rysunku ~\ref{fig:rejestracja-niepowodzenie} przedstawiono ponowne wys³anie ¿¹dania dotycz¹cego rejestracji nowego u¿ytkownika. ¯¹danie wys³ano metod¹ \texttt{POST} ze wszystkimi potrzebnymi danymi w ciele ¿¹dania takimi samymi jak ostatnio co oznacza, ¿e konto nie powinno zostaæ utworzone. W odpowiedzi otrzymano kod odpowiedzi 400 oraz cia³o odpowiedzi informuj¹ce o tym, ¿e konto u¿ytkownika z takim loginem istnieje ju¿ w systemie i nie zosta³o stworzone nowe. Przeprowadzony test potwierdza poprawnoœæ zaimplementowanej funkcji.

\begin{figure}[htb]
  \centering
	\includegraphics[width=0.7\textwidth]{rys06/rejestracja-niepowodzenie}
	\caption{Wys³anie ¿¹dania rejestracji nowego u¿ytkownika z aplikacji Postman - niepowodzenie}
  \label{fig:rejestracja-niepowodzenie}
\end{figure}

Wed³ug wczeœniej zdefiniowanych wymagañ, niektóre z funkcji powinny byæ dostêpne jedynie dla okreœlonej roli. Na rysunku ~\ref{fig:opinie_bez_logowania} przedstawiono wys³anie ¿¹dania dotycz¹cego uzyskania opinii o danym trenerze. Jako parametr przekazano ID trenera o którym chcemy otrzymaæ opinie. Jako odpowiedŸ otrzymano jedynie kod odpowiedzi 401. Oznacza to, ¿e w pliku cookie nie znajduje siê informacja o roli, aby uzyskaæ dostêp do tego zasobu.

\begin{figure}[htb]
  \centering
	\includegraphics[width=0.7\textwidth]{rys06/opinie_bez_logowania}
	\caption{Wys³anie ¿¹dania uzyskania opinii o trenerze nie bêd¹c zalogowanym}
  \label{fig:opinie_bez_logowania}
\end{figure}

Na rysunku~\ref{fig:opinie_sukces} przedstawiono wys³anie ¿¹dania dotycz¹cego opinii o trenerze w momencie, gdy u¿ytkownik jest zalogowany. W odpowiedzi otrzymano kod odpowiedzi 200, natomiast w ciele odpowiedzi zosta³y wyœwietlone opinie zapisane w formacie JSON. Ponadto, wraz z ¿¹daniem zosta³ wys³any token JWT zapisany w pliku cookies. Zosta³o to przedstawione na rysunku ~\ref{fig:opinie_cookies}. Potwierdza to poprawnoœæ zaimplementowanej funkcjonalnoœci. 

\begin{figure}[htb]
  \centering
	\includegraphics[width=0.7\textwidth]{rys06/opinie_sukces}
	\caption{Wys³anie ¿¹dania uzyskania opinii o trenerze bêd¹c zalogowanym}
  \label{fig:opinie_sukces}
\end{figure}

\begin{figure}[htb]
  \centering
	\includegraphics[width=0.7\textwidth]{rys06/opinie_cookies}
	\caption{Wys³ane cookies wraz z ¿¹daniem}
  \label{fig:opinie_cookies}
\end{figure}